<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zeni Vault Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--blue:#3f6df0;--muted:#6b7280}
    body{font-family:'Poppins',sans-serif;background:#f3f6fa;margin:0;color:#222}
    header{background:var(--blue);color:#fff;padding:24px;text-align:center}
    header h1{margin:0;font-size:28px}
    .container{max-width:980px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:18px}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .flex{display:flex;gap:12px;align-items:center}
    .btn{background:var(--blue);color:#fff;padding:10px 16px;border-radius:8px;border:0;cursor:pointer}
    .table{width:100%;border-collapse:collapse}
    .table th{background:#eef3ff;padding:10px;border-bottom:1px solid #e6e9f1;text-align:left}
    .table td{padding:12px;border-bottom:1px solid #eef1f7}
    .package-list{display:flex;gap:12px;flex-wrap:wrap}
    .package{flex:1 1 180px;padding:12px;border-radius:8px;border:1px solid #e7eafc;background:#fff}
    .package h3{margin:0 0 6px}
    .hidden{display:none}
    .small{font-size:13px;color:var(--muted)}
    .refbox{background:#f8fafc;padding:10px;border-radius:8px;border:1px dashed #dbeafe;margin-top:12px}
    footer{background:var(--blue);color:#fff;padding:16px;text-align:center;margin-top:36px}
    input,select{padding:8px;border:1px solid #e2e8f0;border-radius:8px;width:100%}
    .upload-row{display:flex;gap:12px;align-items:center}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ’° Zeni Vault Dashboard</h1>
  </header>

  <div class="container">
    <div class="card center" id="loadingCard">
      <p id="loadingText">Loading your investment data...</p>
    </div>

    <div class="card hidden" id="dashboardCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="userName">Hello</strong><div class="small" id="userContact"></div>
        </div>
        <div>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="refbox" style="margin-top:12px">
        <div><strong>Your referral link:</strong></div>
        <div id="refLink" class="small"></div>
        <div class="small" style="margin-top:6px">Referral bonus: <strong>20%</strong> of the deposit amount.</div>
      </div>

      <h3 style="margin-top:18px">Your investments</h3>
      <div id="investmentsWrap" class="muted small">If you have investments recorded in the Google sheet with your name & contact, they will appear here.</div>

      <hr style="margin:18px 0">

      <h3>Select package & pay</h3>
      <div class="package-list" id="packages"></div>

      <div id="bankDetails" class="hidden" style="margin-top:18px">
        <div class="small">DEPOSIT INTO: <strong>TYME BANK</strong></div>
        <div class="small">ACC NUMBER: <strong>5300 1355 373</strong></div>
        <div class="small">REF: <strong id="bankRef"></strong> (use your contact used to register)</div>

        <div style="margin-top:12px">
          <label>Upload proof of payment (image/pdf)</label>
          <div class="upload-row">
            <input type="file" id="proofFile" accept="image/*,application/pdf" />
            <button class="btn" id="sendProofBtn">Send proof (email)</button>
          </div>
          <div id="sendMsg" class="small muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <div class="card hidden" id="tableCard">
      <table class="table" id="dataTable">
        <thead>
          <tr>
            <th>Name | Contact | Package | Amount | Date Invested | Daily Return | Total Return</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
  </div>

  <footer>Â© 2025 Zeni Vault</footer>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
/* ---------------------------
  Configuration (editable)
---------------------------- */
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZWiVZXMDk1ucOx9bjbwGS2H8rWQVEu9D93ODyHic-bIHpqXEePe0_4vvCKhlvnpH1-QXBC85fM3S0/pub?output=csv";

const EMAILJS_SERVICE = "service_zenivault";
const EMAILJS_TEMPLATE = "template_proof";
const EMAILJS_PUBLIC_KEY = "w-FZyzfjZq7EjnEVs"; // as provided
const EMAIL_TARGET = "zenivault5@gmail.com"; // proof destination

/* ---------------------------
  Packages (yours)
---------------------------- */
const PACKAGES = [
  { id:"starter", title:"Starter", deposit:"R200", daily:"R60", duration:"45 days", total:"R2700" },
  { id:"starter_pro", title:"Starter Pro", deposit:"R500", daily:"R150", duration:"45 days", total:"R6750" },
  { id:"standard", title:"Standard", deposit:"R1000", daily:"R300", duration:"45 days", total:"R13500" },
  { id:"premium", title:"Premium", deposit:"R2000", daily:"R600", duration:"45 days", total:"R27000" },
  { id:"elite", title:"Elite", deposit:"R5000", daily:"R1500", duration:"45 days", total:"R67500" }
];

/* ---------------------------
  Boot
---------------------------- */
(function(){
  // initialize EmailJS
  if(window.emailjs && EMAILJS_PUBLIC_KEY){
    emailjs.init(EMAILJS_PUBLIC_KEY);
  }

  const $loadingCard = document.getElementById('loadingCard');
  const $dashboardCard = document.getElementById('dashboardCard');
  const $tableCard = document.getElementById('tableCard');
  const $userName = document.getElementById('userName');
  const $userContact = document.getElementById('userContact');
  const $refLink = document.getElementById('refLink');
  const $bankRef = document.getElementById('bankRef');
  const $investWrap = document.getElementById('investmentsWrap');
  const $dataBody = document.getElementById('dataBody');
  const $packages = document.getElementById('packages');
  const $bankDetails = document.getElementById('bankDetails');
  const $proofFile = document.getElementById('proofFile');
  const $sendProofBtn = document.getElementById('sendProofBtn');
  const $sendMsg = document.getElementById('sendMsg');
  const $logoutBtn = document.getElementById('logoutBtn');

  // Session
  const session = JSON.parse(localStorage.getItem('zeni_current') || 'null');
  if(!session){ // not logged in -> redirect to login
    // quick fallback: go to login
    location.href = 'login.html';
    return;
  }

  // show user
  $userName.textContent = session.name;
  $userContact.textContent = session.contact;
  const referralCode = "ZV-" + session.contact;
  const myRefLink = location.origin + location.pathname.replace(/index\.html$/,'') + 'register.html?ref=' + encodeURIComponent(referralCode);
  $refLink.textContent = myRefLink;
  $bankRef.textContent = session.contact;

  // logout handler
  $logoutBtn.addEventListener('click', ()=>{
    localStorage.removeItem('zeni_current');
    location.href = 'login.html';
  });

  // render packages
  PACKAGES.forEach(p=>{
    const div = document.createElement('div');
    div.className = 'package';
    div.innerHTML = `
      <h3>${p.title}</h3>
      <div class="small">Deposit: <strong>${p.deposit}</strong></div>
      <div class="small">Daily: <strong>${p.daily}</strong></div>
      <div class="small">Duration: <strong>${p.duration}</strong></div>
      <div style="margin-top:8px">
        <button class="btn selectPackage" data-id="${p.id}">Select ${p.title}</button>
      </div>
    `;
    $packages.appendChild(div);
  });

  // handle package selection
  $packages.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.selectPackage');
    if(!btn) return;
    const id = btn.dataset.id;
    const pkg = PACKAGES.find(x=>x.id === id);
    if(!pkg) return;
    // show bank details and set reference to contact
    $bankDetails.classList.remove('hidden');
    $sendMsg.textContent = `Selected: ${pkg.title}. Please deposit ${pkg.deposit} to the bank details below and upload proof.`;
    // attach package info to send button dataset
    $sendProofBtn.dataset.package = JSON.stringify(pkg);
  });

  // send proof using EmailJS (client-side). We will include the file as base64 (if small) or just send user details and name.
  $sendProofBtn.addEventListener('click', async ()=>{
    const pkg = JSON.parse($sendProofBtn.dataset.package || '{}');
    if(!pkg.id){ $sendMsg.textContent = "Please select a package first."; return; }
    const file = $proofFile.files[0];
    $sendMsg.textContent = "Sending proof, please wait...";
    // prepare template params
    const templateParams = {
      to_email: EMAIL_TARGET,
      user_name: session.name,
      user_contact: session.contact,
      package_selected: pkg.title,
      deposit_amount: pkg.deposit,
      account_details: "TYME BANK â€” ACC: 5300 1355 373 â€” REF: " + session.contact,
      message: "Proof of payment uploaded by user " + session.name + " (" + session.contact + ")"
    };

    // If file present, convert to base64 for the template (beware of size)
    if(file){
      try {
        const base64 = await toBase64(file);
        templateParams.proof_base64 = base64;
        templateParams.proof_filename = file.name;
      } catch(e){
        console.error(e);
      }
    }

    // send via emailjs
    try {
      if(!window.emailjs){ throw new Error("EmailJS not available. Make sure the public key is set."); }
      await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, templateParams);
      $sendMsg.textContent = "Proof sent â€” thank you! We'll email you if we need anything.";
    } catch (err){
      console.error(err);
      $sendMsg.textContent = "Failed to send proof. Please email proof to: " + EMAIL_TARGET + " (or try again).";
    }
  });

  function toBase64(file){ return new Promise((res,rej)=>{
    const reader = new FileReader();
    reader.onload = ()=> res(reader.result);
    reader.onerror = ()=> rej(reader.error);
    reader.readAsDataURL(file);
  }); }

  // fetch sheet csv, parse and display only rows that match session.name OR session.contact
  fetch(SHEET_CSV_URL).then(r=>{
    if(!r.ok) throw new Error("Failed to fetch sheet: " + r.status);
    return r.text();
  }).then(text=>{
    const rows = csvToArray(text);
    // expected columns (depending on your sheet): Name, Contact, Package, Amount, DateInvested, DailyReturn, TotalReturn
    // Try to map header names case-insensitively.
    if(rows.length === 0){ $investWrap.textContent = "No data found in your sheet."; showDashboard(); return; }

    const headers = Object.keys(rows[0]).map(h=>h.toLowerCase());
    // filter rows for this user
    const filtered = rows.filter(r=>{
      const nameMatch = (r.Name && r.Name.toString().trim().toLowerCase() === session.name.toLowerCase());
      const contactMatch = (r.Contact && r.Contact.toString().trim() === session.contact);
      return nameMatch || contactMatch;
    });

    if(filtered.length === 0){
      $investWrap.textContent = "No investment rows found for your account in the sheet.";
    } else {
      $investWrap.textContent = "";
      $tableCard.classList.remove('hidden');
      // fill table body
      $dataBody.innerHTML = '';
      filtered.forEach(row=>{
        const name = row.Name || row.name || '';
        const contact = row.Contact || row.contact || '';
        const pkg = row.Package || row.package || '';
        const amount = row.Amount || row.amount || '';
        const date = row.Date || row.DateInvested || row.date || row.dateinvested || '';
        const daily = row.DailyReturn || row.dailyreturn || row.Daily || '';
        const total = row.TotalReturn || row.totalreturn || row.total || '';
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.innerHTML = `<strong>${name}</strong> &nbsp; ${contact} &nbsp; | &nbsp; <strong>${pkg}</strong> &nbsp; | &nbsp; ${amount} &nbsp; | &nbsp; ${date} &nbsp; | &nbsp; ${daily} &nbsp; | &nbsp; ${total}`;
        tr.appendChild(td);
        $dataBody.appendChild(tr);
      });
    }
    showDashboard();
  }).catch(err=>{
    console.error(err);
    $investWrap.textContent = "Could not load sheet data (network or URL issue).";
    showDashboard();
  });

  function showDashboard(){
    $loadingCard.classList.add('hidden');
    $dashboardCard.classList.remove('hidden');
  }

  // simple CSV parse to array of objects
  function csvToArray(str, delimiter = ",") {
    const lines = str.trim().split(/\r?\n/).map(l => l.trim());
    if(lines.length === 0) return [];
    // find header line (first non-empty)
    const headerLine = lines.shift();
    const headers = parseCsvRow(headerLine, delimiter);
    return lines
      .filter(l => l.length > 0)
      .map(line => {
        const values = parseCsvRow(line, delimiter);
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : '');
        return obj;
      });
  }
  function parseCsvRow(row, delimiter){
    // simple splitting (doesn't fully support quoted commas)
    // for typical simple sheets this is OK. If you need robust parsing, use a CSV parser lib.
    const out = [];
    let cur = '', inQuotes=false;
    for(let i=0;i<row.length;i++){
      const ch = row[i];
      if(ch === '"' ){ inQuotes = !inQuotes; continue; }
      if(ch === delimiter && !inQuotes){ out.push(cur); cur=''; continue; }
      cur += ch;
    }
    out.push(cur);
    return out;
  }

})();
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Check if a user is logged in
  const loggedInUser = JSON.parse(localStorage.getItem("zenivault_user"));

  if (!loggedInUser) {
    // No user data found â€” redirect to login
    window.location.href = "login.html";
    return;
  }

  // Show dashboard content if logged in
  const dashboard = document.getElementById("dashboard");
  if (dashboard) {
    dashboard.innerHTML = `
      <h2>Welcome, ${loggedInUser.name} ðŸ‘‹</h2>
      <p>Your investment details will appear below:</p>
      <div class="card">
        <p><strong>Package:</strong> ${loggedInUser.package}</p>
        <p><strong>Deposit:</strong> R${loggedInUser.deposit}</p>
        <p><strong>Daily Return:</strong> R${loggedInUser.dailyReturn}</p>
        <p><strong>Duration:</strong> ${loggedInUser.duration} days</p>
        <p><strong>Total Income:</strong> R${loggedInUser.totalIncome}</p>
      </div>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    `;
  }

  // Handle logout
  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "logoutBtn") {
      localStorage.removeItem("zenivault_user");
      window.location.href = "login.html";
    }
  });
});
</script>

</body>
</html>
